<div class="course-management-container">

  <!-- Add New Course Form -->
   <form [formGroup]="courseForm" (ngSubmit)="editCourse ? updateCourse(editCourse.id) : addCourse()" class="course-form">
    <h3>{{ editCourse ? '‚úèÔ∏è Edit Course' : '‚ûï Add New Course' }}</h3>

    <!-- <mat-form-field appearance="outline" >
    <mat-label>Course Image</mat-label>
    <input type="file" (change)="onFileSelected($event)" accept="image/*" />
  </mat-form-field> -->
<br>
    <mat-form-field appearance="outline">
      <mat-label>Course Name</mat-label>
      <input matInput formControlName="courseName" required>
      <mat-error *ngIf="courseForm.get('courseName')?.hasError('required')">
        Course name is required
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Description</mat-label>
      <textarea matInput formControlName="description" required></textarea>
      <mat-error *ngIf="courseForm.get('description')?.hasError('required')">
        Description is required
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Tags</mat-label>
      <input matInput formControlName="tags" placeholder="Comma-separated">
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Content Type</mat-label>
      <mat-select formControlName="contentType">
        <mat-option value="video">Video</mat-option>
        <mat-option value="text">Text</mat-option>
        <mat-option value="interactive">Interactive</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Preview URL</mat-label>
      <input matInput formControlName="previewUrl">
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Prerequisites (comma seperated)</mat-label>
      <input matInput formControlName="prerequisites" placeholder="Comma-separated">
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Certificate Link</mat-label>
      <input matInput formControlName="certificateLink" />
    </mat-form-field>

    <mat-checkbox  formControlName="certificate">Certificate Provided</mat-checkbox>
    <mat-checkbox formControlName="selfPaced">Self-Paced</mat-checkbox>

    <mat-form-field appearance="outline">
      <mat-label>Start Date</mat-label>
      <input matInput [matDatepicker]="startPicker" formControlName="startDate">
      <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
      <mat-datepicker #startPicker></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>End Date</mat-label>
      <input matInput [matDatepicker]="endPicker" formControlName="endDate">
      <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
      <mat-datepicker #endPicker></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Category</mat-label>
      <mat-select formControlName="categoryId" required>
        <mat-option *ngFor="let category of categories" [value]="category.id">{{ category.name }}</mat-option>
      </mat-select>
      <mat-error *ngIf="courseForm.get('categoryId')?.hasError('required')">
        Category is required
      </mat-error>
    </mat-form-field>

   <!-- New: Price -->
  <mat-form-field appearance="outline" >
    <mat-label>Price</mat-label>
    <input matInput type="number" formControlName="price" min="0" placeholder="Enter course price" />
    <mat-error *ngIf="courseForm.get('price')?.hasError('min')">Price must be >= 0</mat-error>
  </mat-form-field>

  <!-- New: Discounted Price -->
  <mat-form-field appearance="outline" >
    <mat-label>Discounted Price</mat-label>
    <input matInput type="number" formControlName="discountedPrice" min="0" placeholder="Enter discounted price" />
    <mat-error *ngIf="courseForm.get('discountedPrice')?.hasError('min')">Discounted price must be >= 0</mat-error>
  </mat-form-field>

    <button mat-raised-button color="accent" type="submit">{{ editCourse ? 'Update Course' : 'Add Course' }}</button>
  </form>



  <!-- Course List -->
   <h2>üìö All Courses</h2>
   <!-- Search Bar -->
  <input type="text" placeholder="Search by course name" [(ngModel)]="searchTerm" (input)="onSearchChange()" />

  <!-- Filter Form -->
  <form [formGroup]="filterForm" (ngSubmit)="filterCourses()">
    <select formControlName="categoryId">
      <option value="">All Categories</option>
      <option *ngFor="let category of categories" [value]="category">{{ category.name }}</option>
    </select>

    <select formControlName="status">
      <option value="">All Statuses</option>
      <option value="APPROVED">APPROVED</option>
      <option value="REJECTED">REJECTED</option>
      <option value="true">Archived</option>
    </select>

    <select formControlName="active">
      <option value="">All</option>
      <option [value]="true">Active</option>
      <option [value]="false">Inactive</option>
    </select>

    <button type="submit">Apply Filters</button>
  </form>
    <table mat-table [dataSource]="filteredCourses" class="mat-elevation-z4 full-width-table">

    
        <ng-container matColumnDef="name">
      <th mat-header-cell *matHeaderCellDef> Course Name </th>
      <td mat-cell *matCellDef="let course"> {{ course.courseName }} </td>
    </ng-container>

    <ng-container matColumnDef="category">
      <th mat-header-cell *matHeaderCellDef> Category </th>
      <td mat-cell *matCellDef="let course"> {{ course.category.name }} </td>
    </ng-container>

    <ng-container matColumnDef="price">
    <th mat-header-cell *matHeaderCellDef> Price </th>
    <td mat-cell *matCellDef="let course"> Rs{{ course.price?.toFixed(2) || '0.00' }} </td>
  </ng-container>

  <ng-container matColumnDef="discountedPrice">
    <th mat-header-cell *matHeaderCellDef> Discounted Price </th>
    <td mat-cell *matCellDef="let course">
      <span *ngIf="course.discountedPrice != null && course.discountedPrice < course.price">
        Rs{{ course.discountedPrice.toFixed(2) }}
      </span>
      <span *ngIf="!course.discountedPrice || course.discountedPrice >= course.price">-</span>
    </td>
  </ng-container>

    <ng-container matColumnDef="status">
      <th mat-header-cell *matHeaderCellDef> Status </th>
      <td mat-cell *matCellDef="let course"> {{ course.status }} </td>
    </ng-container>

    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef> Actions </th>
      <td mat-cell *matCellDef="let course">
        <button mat-icon-button color="primary" (click)="startEdit(course)">
          <mat-icon>edit</mat-icon>
        </button>
        <button mat-icon-button color="warn" (click)="deleteCourse(course.id)">
          <mat-icon>delete</mat-icon>
        </button>
        <button mat-icon-button (click)="toggleVisibility(course.id, course.active)">
          <mat-icon>{{ course.active ? 'visibility_off' : 'visibility' }}</mat-icon>
        </button>
        <button mat-button (click)="changeStatus(course.id, 'APPROVED')">Approve</button>
        <button mat-button (click)="changeStatus(course.id, 'REJECTED')">Reject</button>
        <button mat-icon-button (click)="archiveCourse(course.id)">
          <mat-icon>archive</mat-icon>
        </button>
        <button mat-icon-button (click)="unarchiveCourse(course.id)">
          <mat-icon>Unarchive</mat-icon>
        </button>
        <button mat-icon-button (click)="getAuditLogs(course.id)">
          <mat-icon>history</mat-icon>
        </button>
        <button mat-icon-button (click)="getCourseReviews(course.id)">
          <mat-icon>rate_review</mat-icon>
        </button>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="['name', 'category','price','discountedPrice', 'status', 'actions']"></tr>
    <tr mat-row *matRowDef="let row; columns: ['name', 'category','price','discountedPrice', 'status', 'actions']"></tr>
  </table>

  <hr />

    <!-- üë®‚Äçüè´ Assign Faculty -->
  <mat-form-field appearance="outline">
    <mat-label>Assign Faculty Username</mat-label>
    <input matInput [(ngModel)]="assignUserName" />
  </mat-form-field>
  <button mat-raised-button color="primary" (click)="assignFaculty(selectedCourseId!)" [disabled]="!selectedCourseId">
    Assign to Selected Course
  </button>

  <!-- üìù Audit Logs -->
  <div *ngIf="auditLogs.length > 0">
    <h3>Audit Logs</h3>
    <mat-list>
      <mat-list-item *ngFor="let log of auditLogs">
        {{ log.timestamp }} - {{ log.action }} By {{ log.performedBy }}
      </mat-list-item>
    </mat-list>
  </div>

  <!-- ‚≠ê Course Reviews -->
  <div *ngIf="selectedCourseReviews.length > 0">
    <h3>Course Reviews</h3>
    <mat-list>
      <mat-list-item *ngFor="let review of selectedCourseReviews">
        <span>{{ review.comment }}</span>
        <button mat-icon-button (click)="flagReview(review.id)">
          <mat-icon>flag</mat-icon>
        </button>
        <button mat-icon-button color="warn" (click)="deleteReview(review.id)">
          <mat-icon>delete</mat-icon>
        </button>
      </mat-list-item>
    </mat-list>
  </div>

  <!-- üö© Flagged Reviews -->
  <div *ngIf="flaggedReviews.length > 0">
    <h3>Flagged Reviews</h3>
    <mat-list>
      <mat-list-item *ngFor="let review of flaggedReviews">
        {{ review.comment }} - flagged by {{ review.flaggedBy }}
        <button mat-icon-button color="warn" (click)="deleteReview(review.id)">
          <mat-icon>delete</mat-icon>
        </button>
      </mat-list-item>
    </mat-list>
  </div>

  <hr />

   <!-- üß© Category Management -->
  <div>
    <h3>Manage Categories</h3>
    <mat-form-field>
      <mat-label>New Category Name</mat-label>
      <input matInput [(ngModel)]="selectedCategory.name" />
    </mat-form-field>
    <button mat-button (click)="createCategory()">Create</button>
    <div *ngFor="let category of categories">
      <mat-form-field>
        <input matInput [(ngModel)]="category.name" />
      </mat-form-field>
      <button mat-button color="primary" (click)="updateCategory(category)">Update</button>
      <button mat-button color="warn" (click)="deleteCategory(category.id)">Delete</button>
    </div>
  </div>

</div>
